name: READMEì— ì„±ê²½êµ¬ì ˆ ì—…ë°ì´íŠ¸

on:
  schedule:
    - cron: "*/6 * * * *" # 6ë¶„ ë§ˆë‹¤ ì—…ë°ì´íŠ¸
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-bible-verse:
    runs-on: ubuntu-latest

    steps:
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì¹˜
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      - name: README.mdìš© ì„±ê²½ êµ¬ì ˆ ìƒì„±
        run: |
          import pickle
          import random
          import datetime

          # í˜„ì¬ ì‹œê°„ (í•œêµ­ ê¸°ì¤€)
          now = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
          today = now.strftime("%Y-%m-%d %H:%M:%S KST")

          # Pickleì—ì„œ êµ¬ì ˆ ë¶ˆëŸ¬ì˜¤ê¸°
          with open(".github/bible_verses.pkl", "rb") as f:
              verses = pickle.load(f)

          verse = random.choice(verses)
          ref = verse["ref"]
          text = verse["verse"]

          # ì‚½ì…í•  í…ìŠ¤íŠ¸ êµ¬ì„±
          new_content = f"""<!-- START_BIBLE_VERSE -->
ğŸ“– **{ref}**
> {text}

ğŸ•Šï¸ _ì—…ë°ì´íŠ¸ ì‹œê°: {today}_
<!-- END_BIBLE_VERSE -->"""

          # README.md ìˆ˜ì •
          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          import re
          updated = re.sub(r"<!-- START_BIBLE_VERSE -->(.|\n)*?<!-- END_BIBLE_VERSE -->", new_content, content)

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(updated)

        shell: python

      - name: Git ì„¤ì •
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          if [[ -z $(git status --porcelain README.md) ]]; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          else
            git add README.md
            git commit -m "ğŸ“– README ì„±ê²½ êµ¬ì ˆ ìë™ ì—…ë°ì´íŠ¸"
            git push
          fi
